pipeline {
    agent any
    environment {
        DOCKER_CREDENTIALS_ID = 'docker-hub-credentials' // Id des credentials pour Docker Hub
        GIT_CREDENTIALS_ID = 'git-pat-credentials' // Id des credentials pour GitHub
    }
    stages {
        stage ("Clean up") {
            steps {
                sh 'rm -rf /root/.jenkins/workspace/astonvilla/*'
                sh 'ls'
            }
        }
        stage ("Clone repo") {
            steps {
                git branch: 'main', credentialsId: "${GIT_CREDENTIALS_ID}", url: 'https://github.com/meha511/devops.git'
            }
        }
        stage ("Generate docker image") {
            steps {
                dir("astonvilla-app") {
                    sh "docker build -t meha886/astonvilla-app:1.1.${env.BUILD_NUMBER} ."
                }
            }
        }
        stage ("Push docker image") {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', "${DOCKER_CREDENTIALS_ID}") {
                        dir("astonvilla-app") {
                            sh "docker push meha886/astonvilla-app:1.1.${env.BUILD_NUMBER}"
                        }
                    }
                }
            }
        }
    }
}
